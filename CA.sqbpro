<?xml version="1.0" encoding="UTF-8"?><sqlb_project><db path="CA.db" readonly="0" foreign_keys="1" case_sensitive_like="0" temp_store="0" wal_autocheckpoint="1000" synchronous="2"/><attached/><window><main_tabs open="structure browser pragmas query" current="3"/></window><tab_structure><column_width id="0" width="300"/><column_width id="1" width="0"/><column_width id="2" width="100"/><column_width id="3" width="1387"/><column_width id="4" width="0"/><expanded_item id="0" parent="1"/><expanded_item id="1" parent="1"/><expanded_item id="2" parent="1"/><expanded_item id="3" parent="1"/></tab_structure><tab_browse><table title="CAN" custom_title="0" dock_id="1" table="4,3:mainCAN"/><dock_state state="000000ff00000000fd00000001000000020000000000000000fc0100000001fb000000160064006f0063006b00420072006f00770073006500310100000000ffffffff0000011300ffffff000000000000000000000004000000040000000800000008fc00000000"/><default_encoding codec=""/><browse_table_settings/></tab_browse><tab_sql><sql name="SQL 1*">SELECT C.CLI_CODIGO, C.CLI_NOMBRE, C.CLI_CALLE, C.COB_CODIGO, C.ESTADO, T.TAR_CODIGO, T.TAR_VALOR, T.TAR_CUOTA, T.TAR_FECHA, T.ITEN, T.ESTADO, T.TIEMPO, T.FP
FROM CLIENTES C
INNER JOIN TARGETA T
    ON C.CLI_CODIGO = T.CLI_CODIGO

LEFT JOIN (
    SELECT TAR_CODIGO, DES_RESTA
    FROM (
        SELECT 
            TAR_CODIGO,
            DES_RESTA,
            ROW_NUMBER() OVER (PARTITION BY TAR_CODIGO ORDER BY DES_FECHA DESC) AS rn,
            MAX(CASE WHEN DES_RESTA = 0 THEN 1 ELSE 0 END)
                OVER (PARTITION BY TAR_CODIGO) AS tuvo_cero
        FROM DESCRIPCION
    ) X
    WHERE rn = 1
      AND tuvo_cero = 0
) D ON T.TAR_CODIGO = D.TAR_CODIGO

WHERE T.ESTADO = 'ACTIVA'
  AND C.COB_CODIGO = 'Hernan'
  -- esta línea permite tarjetas nuevas SIN descripción
  AND (D.TAR_CODIGO IS NOT NULL OR NOT EXISTS (
        SELECT 1 
        FROM DESCRIPCION D2 
        WHERE D2.TAR_CODIGO = T.TAR_CODIGO
      ))

ORDER BY CAST(T.ITEN AS SIGNED);</sql><sql name="SQL 2*">SELECT 
      C.CLI_CODIGO, 
      C.CLI_NOMBRE, 
      T.TAR_CODIGO, 
      T.TAR_FECHA, 
      T.TAR_VALOR,
      D.FECHA_ACT, 
      D.DES_FECHA, 
      D.DES_ABONO, 
      D.DES_RESTA 
    FROM DESCRIPCION D
    INNER JOIN TARGETA T ON D.TAR_CODIGO = T.TAR_CODIGO
    INNER JOIN CLIENTES C ON T.CLI_CODIGO = C.CLI_CODIGO
    WHERE D.TAR_CODIGO = 'Hernan30'
    ORDER BY C.CLI_CODIGO, TAR_FECHA, CAST(DES_RESTA AS SIGNED) DESC;</sql><sql name="SQL 3*">INSERT INTO DESCRIPCION (TAR_CODIGO, FECHA_ACT, DES_FECHA, DES_ABONO, DES_RESTA)
VALUES ('Hernan30', '07-feb-26-&gt;30', '01-nov-25', 20000, 120000);</sql><current_tab id="1"/></tab_sql></sqlb_project>
