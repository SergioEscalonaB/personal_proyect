<?xml version="1.0" encoding="UTF-8"?><sqlb_project><db path="CA.db" readonly="0" foreign_keys="1" case_sensitive_like="0" temp_store="0" wal_autocheckpoint="1000" synchronous="2"/><attached/><window><main_tabs open="structure browser pragmas query" current="3"/></window><tab_structure><column_width id="0" width="300"/><column_width id="1" width="0"/><column_width id="2" width="100"/><column_width id="3" width="1387"/><column_width id="4" width="0"/><expanded_item id="0" parent="1"/><expanded_item id="1" parent="1"/><expanded_item id="2" parent="1"/><expanded_item id="3" parent="1"/></tab_structure><tab_browse><table title="CAN" custom_title="0" dock_id="1" table="4,3:mainCAN"/><dock_state state="000000ff00000000fd00000001000000020000000000000000fc0100000001fb000000160064006f0063006b00420072006f00770073006500310100000000ffffffff0000011300ffffff000000000000000000000004000000040000000800000008fc00000000"/><default_encoding codec=""/><browse_table_settings/></tab_browse><tab_sql><sql name="SQL 1*">SELECT C.CLI_CODIGO, C.CLI_NOMBRE, C.CLI_CALLE, C.COB_CODIGO, C.ESTADO, T.TAR_CODIGO, T.TAR_VALOR, T.TAR_CUOTA, T.TAR_FECHA, T.ITEN, T.ESTADO, T.TIEMPO, T.FP
FROM CLIENTES C
INNER JOIN TARGETA T
    ON C.CLI_CODIGO = T.CLI_CODIGO

LEFT JOIN (
    SELECT TAR_CODIGO, DES_RESTA
    FROM (
        SELECT 
            TAR_CODIGO,
            DES_RESTA,
            ROW_NUMBER() OVER (PARTITION BY TAR_CODIGO ORDER BY DES_FECHA DESC) AS rn,
            MAX(CASE WHEN DES_RESTA = 0 THEN 1 ELSE 0 END)
                OVER (PARTITION BY TAR_CODIGO) AS tuvo_cero
        FROM DESCRIPCION
    ) X
    WHERE rn = 1
      AND tuvo_cero = 0
) D ON T.TAR_CODIGO = D.TAR_CODIGO

WHERE T.ESTADO = 'ACTIVA'
  AND C.COB_CODIGO = 'Yayo'
  -- esta línea permite tarjetas nuevas SIN descripción
  AND (D.TAR_CODIGO IS NOT NULL OR NOT EXISTS (
        SELECT 1 
        FROM DESCRIPCION D2 
        WHERE D2.TAR_CODIGO = T.TAR_CODIGO
      ))

ORDER BY CAST(T.ITEN AS SIGNED);</sql><sql name="SQL 2*">-- Paso 1: Marcar como INACTIVAS y poner ITEN = NULL a las que NO cumplen la condición
UPDATE TARGETA
SET ESTADO = 'INACTIVA', ITEN = NULL
WHERE TAR_CODIGO IN (
    SELECT T.TAR_CODIGO
    FROM TARGETA T
    INNER JOIN CLIENTES C ON T.CLI_CODIGO = C.CLI_CODIGO
    WHERE C.COB_CODIGO = 'Yayo'
    AND T.ESTADO = 'ACTIVA'
    AND T.TAR_CODIGO NOT IN (
        -- Esta es la subquery de las tarjetas que SÍ deben estar activas
        SELECT T2.TAR_CODIGO
        FROM CLIENTES C2
        INNER JOIN TARGETA T2 ON C2.CLI_CODIGO = T2.CLI_CODIGO
        LEFT JOIN (
            SELECT TAR_CODIGO, DES_RESTA
            FROM (
                SELECT 
                    TAR_CODIGO,
                    DES_RESTA,
                    ROW_NUMBER() OVER (PARTITION BY TAR_CODIGO ORDER BY DES_FECHA DESC) AS rn,
                    MAX(CASE WHEN DES_RESTA = 0 THEN 1 ELSE 0 END)
                        OVER (PARTITION BY TAR_CODIGO) AS tuvo_cero
                FROM DESCRIPCION
            ) X
            WHERE rn = 1 AND tuvo_cero = 0
        ) D ON T2.TAR_CODIGO = D.TAR_CODIGO
        WHERE T2.ESTADO = 'ACTIVA'
          AND C2.COB_CODIGO = 'Yayo'
          AND (D.TAR_CODIGO IS NOT NULL OR NOT EXISTS (
                SELECT 1 FROM DESCRIPCION D2 WHERE D2.TAR_CODIGO = T2.TAR_CODIGO
              ))
    )
);

-- Paso 2: Renumerar solo las ACTIVAS que cumplen la condición
CREATE TEMP TABLE temp_iten AS
SELECT T.TAR_CODIGO, ROW_NUMBER() OVER (ORDER BY CAST(T.ITEN AS REAL)) as nuevo_iten
FROM CLIENTES C
INNER JOIN TARGETA T ON C.CLI_CODIGO = T.CLI_CODIGO
LEFT JOIN (
    SELECT TAR_CODIGO, DES_RESTA
    FROM (
        SELECT 
            TAR_CODIGO,
            DES_RESTA,
            ROW_NUMBER() OVER (PARTITION BY TAR_CODIGO ORDER BY DES_FECHA DESC) AS rn,
            MAX(CASE WHEN DES_RESTA = 0 THEN 1 ELSE 0 END)
                OVER (PARTITION BY TAR_CODIGO) AS tuvo_cero
        FROM DESCRIPCION
    ) X
    WHERE rn = 1 AND tuvo_cero = 0
) D ON T.TAR_CODIGO = D.TAR_CODIGO
WHERE T.ESTADO = 'ACTIVA'
  AND C.COB_CODIGO = 'Yayo'
  AND (D.TAR_CODIGO IS NOT NULL OR NOT EXISTS (
        SELECT 1 FROM DESCRIPCION D2 WHERE D2.TAR_CODIGO = T.TAR_CODIGO
      ));

-- Paso 3: Actualizar con los nuevos ITEN consecutivos
UPDATE TARGETA
SET ITEN = (SELECT nuevo_iten FROM temp_iten WHERE temp_iten.TAR_CODIGO = TARGETA.TAR_CODIGO)
WHERE TAR_CODIGO IN (SELECT TAR_CODIGO FROM temp_iten);

-- Paso 4: Limpiar
DROP TABLE temp_iten;
</sql><current_tab id="0"/></tab_sql></sqlb_project>
